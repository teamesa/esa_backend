<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Document</title>
    <link rel="stylesheet" href="../../static/css/table.css" th:href="@{/css/table.css}">
    <script src="https://code.jquery.com/jquery-3.4.1.js"></script>
</head>
<body>

<form action="" th:action th:object="${item}" method="post" enctype="multipart/form-data">
    <table class="tg">
        <colgroup>
            <col width="10%">
            <col width="*%">
            <col width="10%">
            <col width="*%">
        </colgroup>
        <thead>
        <tr>
            <th class="mainTitle" colspan="4">문화생활 상세</th>
        </tr>
        </thead>
        <tbody>
        <tr>
            <td class="mainTitle" colspan="4">기본정보</td>
        </tr>
        <tr>
            <td class="subTitle">문화생활 유형 *</td>
            <td>
                <div th:each="type : ${exhibitionTypes}">
                    <input type="radio" th:field="*{exhibitionType}" th:value="${type.name()}">
                    <label th:for="${#ids.prev('exhibitionType')}" th:text="${type.description}">

                    </label>
                </div>
            </td>
            <td class="subTitle">FO 전시여부</td>
            <td>
                <div th:each="type : ${exposureTypes}">
                    <input type="radio" th:field="*{exposureType}" th:value="${type.name()}">
                    <label th:for="${#ids.prev('exposureType')}" th:text="${type.description}">

                    </label>
                </div>
            </td>
        </tr>
        <tr>
            <td class="subTitle">진행기간</td>
            <td colspan="3">
                <div>
                    <label for="startDate">시작일 * </label>
                    <input type="date" id="startDate" th:field="*{startDate}">
                </div>
                <div>
                    <label for="endDate">종료일 * </label>
                    <input type="date" id="endDate" th:field="*{endDate}">
                </div>
            </td>
        </tr>
        <tr>
            <td class="subTitle">메인타이틀</td>
            <td colspan="3">
                <input type="text" id="title" th:field="*{title}" placeholder="제목을 입력하세요">
            </td>
        </tr>
        <tr>
            <td class="subTitle">장소명</td>
            <td colspan="3">
                <input type="text" id="place" th:field="*{placeName}" placeholder="장소를 입력하세요">
            </td>
        </tr>
        <tr>
            <td class="subTitle">장소 위도</td>
            <td>
                <input type="text" id="latitude" th:field="*{latitude}" placeholder="위도를 입력하세요">
            </td>
            <td class="subTitle">장소 경도</td>
            <td>
                <input type="text" id="longitude" th:field="*{longitude}" placeholder="경도를 입력하세요">
            </td>
        </tr>
        <tr>
            <td class="subTitle">입장료 *</td>
            <td colspan="3">
                <div th:each="type : ${feeTypes}">
                    <input type="radio" th:field="*{fee}" th:value="${type.name()}">
                    <label th:for="${#ids.prev('fee')}" th:text="${type.description}">
                        BOOK
                    </label>
                </div>
            </td>
        </tr>
        <tr>
            <td class="subTitle">유료 입장료 가격</td>
            <td>
                <input type="text" id="price" th:field="*{price}" placeholder="요금을 입력하세요">
            </td>
            <td class="subTitle">티켓구매 URL</td>
            <td>
                <input type="text" id="ticketUrl" th:field="*{ticketUrl}" placeholder="티켓 구매 url 입력하세요">
            </td>
        </tr>
        <tr>
            <td class="subTitle">지역구분 *</td>
            <td colspan="3">
                <div th:each="type : ${regionTypes}">
                    <input type="radio" th:field="*{regionType}" th:value="${type.name()}">
                    <label th:for="${#ids.prev('regionType')}" th:text="${type.description}">
                        Seoul
                    </label>
                </div>
            </td>
        </tr>
        <tr>
            <td class="subTitle">홈페이지링크</td>
            <td colspan="3">
                <input type="text" id="url" th:field="*{homepageUrl}" placeholder="링크를 입력하세요">
            </td>
        </tr>
        <tr>
            <td class="subTitle">시간</td>
            <td colspan="3">
                <input type="text" id="time" th:field="*{time}" placeholder="시간를 입력하세요">
            </td>
        </tr>
        <tr>
            <td class="subTitle">리스트 이미지 *</td>
            <td colspan="3">
                <input type="file" id="listImageUrl" th:field="*{listImageUrl}" placeholder="사진">
                <div id="listPreview"></div>
                <a href="#" class="btn-delete">삭제</a>
            </td>
        </tr>
        <tr>
            <td class="subTitle">썸네일 이미지 *</td>
            <td colspan="3">
                <input type="file" id="thumbnailImageUrl" th:field="*{thumbnailImageUrl}" placeholder="사진">
                <div id="thumbnailPreview"></div>
                <a href="#" class="btn-delete">삭제</a>
            </td>
        </tr>
        <tr>
            <td class="mainTitle" colspan="4">소개</td>
        </tr>
        <tr>
            <td>소개</td>
            <td colspan="3">
                <input type="text" id="introduce" th:field="*{introduce}" placeholder="소개글">
            </td>
        </tr>
        <tr>
            <td>소개이미지</td>
            <td colspan="3">
                <div id="btnDiv">
                    <div data-name="fileDiv">
                        <label for="detailImageUrls[0]">파일1</label>
                        <input type="file" id="detailImageUrls[0]" th:field="*{detailImageUrls[0]}">
                        <button type="button" onclick="addFile()"> 추가</button>
                        <button type="button" onclick="removeFile(this)"> 삭제</button>
                    </div>
                </div>
                <div th:each="image : *{getDetailImageUrls}">
                    <div data-image="savedImageDiv">
                        <img width="100px" height="100px" th:src="${image}" alt="이미지 없음">
                        <button type="button" onclick="removeImage(this)"> 삭제</button>
                    </div>
                </div>
            </td>
        </tr>
        <tr>
            <td class="mainTitle" colspan="4">
                <button type="submit">저장</button>
            </td>
        </tr>
        </tbody>
    </table>
</form>

<form action="/form/items" method="get">
    <button type="submit" class="button">취소</button>
</form>

<script th:inline="javascript">

    var editId = [[${item.id}]];

    function readInputFile(input) {
        console.log(input.files);
        if (input.files && input.files[0]) {
            var reader = new FileReader();
            reader.onload = function (e) {
                $('#existing').remove();
                $('#preview').html("<img style=\"width: 100px; height: 100px;\" src=" + e.target.result + ">");
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    $.ajax("/form/items/" + editId + "/edit")
        .done(function () {
            $("#image").on('change', function () {
                readInputFile(this);
            });
        })


    // 등록 이미지 삭제 ( input file reset )
    function resetInputFile($input, $preview) {
        var agent = navigator.userAgent.toLowerCase();
        if ((navigator.appName == 'Netscape' && navigator.userAgent.search('Trident') != -1) || (agent.indexOf("msie") != -1)) {
            // ie 일때
            $input.replaceWith($input.clone(true));
            $preview.empty();
        } else {
            //other
            $input.val("");
            $preview.empty();
        }
    }

    $(".btn-delete").click(function (event) {
        var $input = $("#image");
        var $preview = $('#preview');
        resetInputFile($input, $preview);
    });
</script>

<script th:inline="javascript">
    let fileIdx = 0;
    let deleteImageIdx = 0;

    function addFile() {
        fileIdx++;
        const fileHtml = `
        <div data-name="fileDiv">
            <label for="detailImageUrl[${fileIdx}]">파일${fileIdx + 1}</label>
            <input type="file" id="detailImageUrl[${fileIdx}]" name="detailImageUrl[${fileIdx}]">
            <button type="button" onclick="removeFile(this)"> 삭제 </button>
        </div>
	`;
        $('#btnDiv').append(fileHtml);
    }

    function removeFile(elem) {

        fileIdx--;

        const prevTag = $(elem).prev().prop('tagName');
        if (prevTag === 'BUTTON') {
            const file = $(elem).prevAll('input[type="file"]');
            file.val('');
            return false;
        }

        const target = $(elem).parents('div[data-name="fileDiv"]');
        target.remove();
    }

    function removeImage(elem) {

        console.log("hihi1");

        let imageId = $(elem).prev().text();
        const fileHtml = `
        <div data-image="savedImageDiv">
            <input type="hidden" name="deleteImageIndex[${deleteImageIdx}]" value="${imageId}">
        </div>
	`;
        $('#btnDiv').append(fileHtml);

        deleteImageIdx++;

        console.log("hihi2");

        const target = $(elem).parents('div[data-image="savedImageDiv"]');
        target.remove();
    }
</script>

</body>
</html>